alter user VEERAMANICADAS set default_role = 'SYSADMIN';
alter user VEERAMANICADAS set default_warehouse = 'COMPUTE_WH';
alter user VEERAMANICADAS set default_namespace = 'UTIL_DB.PUBLIC';

ALTER USER VEERAMANICADAS SET DEFAULT_ROLE = 'SYSADMIN';


create database AGS_GAME_AUDIENCE;

create schema RAW;

drop schema public;

list @uni_kishore/kickoff;

CREATE OR REPLACE FILE FORMAT FF_JSON_LOGS
  TYPE = JSON
  STRIP_OUTER_ARRAY = TRUE
;

select $1 
from @uni_kishore/kickoff/DNGW_Sample_from_Agnies_Game.json
(file_format => ff_json_logs);

copy into ags_game_audience.raw.game_logs
from @uni_kishore/kickoff
file_format = (format_name=ff_json_logs);

select raw_log:agent::text as AGENT 
, RAW_LOG:user_event::text as USER_EVENT 
, *
from game_logs; 

select raw_log:agent::text as AGENT 
, RAW_LOG:user_event::text as USER_EVENT
, RAW_LOG:user_login::text as USER_LOGIN
, RAW_LOG:datetime_iso8601::TIMESTAMP_NTZ as DATETIME_ISO8601
, *
from game_logs; 

CREATE OR REPLACE VIEW LOGS  as (
select raw_log:agent::text as AGENT 
, RAW_LOG:user_event::text as USER_EVENT
, RAW_LOG:user_login::text as USER_LOGIN
-- , RAW_LOG:datetime_iso8601::TIMESTAMP_NTZ as DATETIME_ISO8601
, TO_TIMESTAMP_NTZ(RAW_LOG:datetime_iso8601::TEXT) AS DATETIME_ISO8601
, *
from game_logs
);


SELECT * FROM LOGS;


list @uni_kishore;

select $1, $2, $3, $4
from @uni_kishore/updated_feed/DNGW_updated_feed_0_0_0.json;

DESC STAGE uni_kishore;


copy into ags_game_audience.raw.game_logs
from @uni_kishore/updated_feed
file_format = (format_name=ff_json_logs);

select * from game_logs;

select raw_log, 
raw_log:agent::text as AGENT 
, RAW_LOG:ip_address::text
, RAW_LOG:user_event::text as USER_EVENT
, RAW_LOG:datetime_iso8601::TIMESTAMP_NTZ as DATETIME_ISO8601
, RAW_LOG:user_login::text as USER_LOGIN
, *
from game_logs; 

select * from logs;

select * from logs where agent is not null;

select * from logs where agent is null;

--looking for empty AGENT column
select * 
from ags_game_audience.raw.LOGS
where agent is null;

--looking for non-empty IP_ADDRESS column
select 
RAW_LOG:ip_address::text as IP_ADDRESS
,*
from ags_game_audience.raw.LOGS
where RAW_LOG:ip_address::text is not null;



CREATE OR REPLACE VIEW LOGS  as (
select RAW_LOG:ip_address::text as IP_ADDRESS 
, RAW_LOG:user_event::text as USER_EVENT
, RAW_LOG:user_login::text as USER_LOGIN
, RAW_LOG:datetime_iso8601::TIMESTAMP_NTZ as DATETIME_ISO8601
, *
from game_logs where RAW_LOG:ip_address::text is not null
);

select * from logs;

SELECT CURRENT_TIMESTAMP();

--what time zone is your account(and/or session) currently set to? Is it -0700?
select current_timestamp();

--worksheets are sometimes called sessions -- we'll be changing the worksheet time zone
alter session set timezone = 'UTC';
select current_timestamp();

--how did the time differ after changing the time zone for the worksheet?
alter session set timezone = 'Africa/Nairobi';
select current_timestamp();

alter session set timezone = 'Pacific/Funafuti';
select current_timestamp();

alter session set timezone = 'Asia/Shanghai';
select current_timestamp();

--show the account parameter called timezone
show parameters like 'timezone';

alter session set timezone = 'Pacific/Funafuti';
select current_timestamp();


SET denver_time = TO_TIMESTAMP_NTZ('2022-10-15 19:22:00');

SELECT
  CONVERT_TIMEZONE(
    'America/Denver',
    'UTC',
    $denver_time
  ) AS utc_time;


select * from logs WHERE USER_LOGIN ilike '%prajina%';

select parse_ip('100.41.16.160','inet');


select parse_ip('107.217.231.17','inet');

select parse_ip('107.217.231.17','inet'):host;

select parse_ip('100.41.16.160','inet'):ipv4 as number;


--Look up Kishore and Prajina's Time Zone in the IPInfo share using his headset's IP Address with the PARSE_IP function.
select start_ip, end_ip, start_ip_int, end_ip_int, city, region, country, timezone
from IPINFO_GEOLOC.demo.location
where parse_ip('100.41.16.160', 'inet'):ipv4 --Kishore's Headset's IP Address
BETWEEN start_ip_int AND end_ip_int;

--Join the log and location tables to add time zone to each row using the PARSE_IP function.
select logs.*
       , loc.city
       , loc.region
       , loc.country
       , loc.timezone
from AGS_GAME_AUDIENCE.RAW.LOGS logs
join IPINFO_GEOLOC.demo.location loc
where parse_ip(logs.ip_address, 'inet'):ipv4 
BETWEEN start_ip_int AND end_ip_int;


--Use two functions supplied by IPShare to help with an efficient IP Lookup Process!
SELECT logs.ip_address
, logs.user_login
, logs.user_event
, logs.datetime_iso8601
, city
, region
, country
, timezone 
, convert_timezone('UTC', timezone, to_timestamp_ntz(logs.datetime_iso8601)) as GAME_EVENT_LTZ 
, dayname(GAME_EVENT_LTZ) as DOW_NAME
from AGS_GAME_AUDIENCE.RAW.LOGS logs
JOIN IPINFO_GEOLOC.demo.location loc 
ON IPINFO_GEOLOC.public.TO_JOIN_KEY(logs.ip_address) = loc.join_key
AND IPINFO_GEOLOC.public.TO_INT(logs.ip_address) 
BETWEEN start_ip_int AND end_ip_int;



-- Your role should be SYSADMIN
-- Your database menu should be set to AGS_GAME_AUDIENCE
-- The schema should be set to RAW

--a Look Up table to convert from hour number to "time of day name"
create table ags_game_audience.raw.time_of_day_lu
(  hour number
   ,tod_name varchar(25)
);

--insert statement to add all 24 rows to the table
insert into time_of_day_lu
values
(6,'Early morning'),
(7,'Early morning'),
(8,'Early morning'),
(9,'Mid-morning'),
(10,'Mid-morning'),
(11,'Late morning'),
(12,'Late morning'),
(13,'Early afternoon'),
(14,'Early afternoon'),
(15,'Mid-afternoon'),
(16,'Mid-afternoon'),
(17,'Late afternoon'),
(18,'Late afternoon'),
(19,'Early evening'),
(20,'Early evening'),
(21,'Late evening'),
(22,'Late evening'),
(23,'Late evening'),
(0,'Late at night'),
(1,'Late at night'),
(2,'Late at night'),
(3,'Toward morning'),
(4,'Toward morning'),
(5,'Toward morning');


--Check your table to see if you loaded it properly
select tod_name, listagg(hour,',') 
from time_of_day_lu
group by tod_name;


SELECT logs.ip_address
, logs.user_login as GAMER_NAME
, logs.user_event as GAME_EVENT_NAME
, logs.datetime_iso8601 as GAME_EVENT_UTC
, city
, region
, country
, timezone as GAMER_LTZ_NAME
, convert_timezone('UTC', timezone, to_timestamp_ntz(logs.datetime_iso8601)) as GAME_EVENT_LTZ 
, dayname(GAME_EVENT_LTZ) as DOW_NAME
, TOD_NAME
from AGS_GAME_AUDIENCE.RAW.LOGS logs
JOIN IPINFO_GEOLOC.demo.location loc 
ON IPINFO_GEOLOC.public.TO_JOIN_KEY(logs.ip_address) = loc.join_key
AND IPINFO_GEOLOC.public.TO_INT(logs.ip_address) 
BETWEEN start_ip_int AND end_ip_int
join AGS_GAME_AUDIENCE.RAW.time_of_day_lu ON hour = HOUR(GAME_EVENT_LTZ);

create schema enhanced;

create or replace table ags_game_audience.enhanced.logs_enhanced as(
    SELECT logs.ip_address
, logs.user_login as GAMER_NAME
, logs.user_event as GAME_EVENT_NAME
, logs.datetime_iso8601 as GAME_EVENT_UTC
, city
, region
, country
, timezone as GAMER_LTZ_NAME
, convert_timezone('UTC', timezone, to_timestamp_ntz(logs.datetime_iso8601)) as GAME_EVENT_LTZ 
, dayname(GAME_EVENT_LTZ) as DOW_NAME
, TOD_NAME
from AGS_GAME_AUDIENCE.RAW.LOGS logs
JOIN IPINFO_GEOLOC.demo.location loc 
ON IPINFO_GEOLOC.public.TO_JOIN_KEY(logs.ip_address) = loc.join_key
AND IPINFO_GEOLOC.public.TO_INT(logs.ip_address) 
BETWEEN start_ip_int AND end_ip_int
join AGS_GAME_AUDIENCE.RAW.time_of_day_lu ON hour = HOUR(GAME_EVENT_LTZ)
);


select * from ags_game_audience.enhanced.logs_enhanced;



--first we dump all the rows out of the table
truncate table ags_game_audience.enhanced.LOGS_ENHANCED;

--then we put them all back in
INSERT INTO ags_game_audience.enhanced.LOGS_ENHANCED (
SELECT logs.ip_address 
, logs.user_login as GAMER_NAME
, logs.user_event as GAME_EVENT_NAME
, logs.datetime_iso8601 as GAME_EVENT_UTC
, city
, region
, country
, timezone as GAMER_LTZ_NAME
, CONVERT_TIMEZONE( 'UTC',timezone,logs.datetime_iso8601) as game_event_ltz
, DAYNAME(game_event_ltz) as DOW_NAME
, TOD_NAME
from ags_game_audience.raw.LOGS logs
JOIN ipinfo_geoloc.demo.location loc 
ON ipinfo_geoloc.public.TO_JOIN_KEY(logs.ip_address) = loc.join_key
AND ipinfo_geoloc.public.TO_INT(logs.ip_address) 
BETWEEN start_ip_int AND end_ip_int
JOIN ags_game_audience.raw.TIME_OF_DAY_LU tod
ON HOUR(game_event_ltz) = tod.hour);

--Hey! We should do this every 5 minutes from now until the next millennium - Y3K!!!
--Alexa, play Yeah by Usher!

--clone the table to save this version as a backup (BU stands for Back Up)
create or replace table ags_game_audience.enhanced.LOGS_ENHANCED_BU 
clone ags_game_audience.enhanced.LOGS_ENHANCED;

select * from ENHANCED.LOGS_ENHANCED;

select * from logs;


MERGE INTO ENHANCED.LOGS_ENHANCED e
USING RAW.LOGS r
ON r.user_login = e.GAMER_NAME
and r.datetime_iso8601 = e.game_event_utc
and r.user_event = e.GAME_EVENT_NAME
WHEN MATCHED THEN
UPDATE SET IP_ADDRESS = 'Hey I updated matching rows!';

select * from ENHANCED.LOGS_ENHANCED;

SHOW TABLES
  ->> SELECT "name", "retention_time"
        FROM $1
        WHERE "name" IN ('LOGS_ENHANCED', 'LOGS_ENHANCED_BU');


SELECT * FROM LOGS_ENHANCED AT(OFFSET => -60*15);

SELECT * FROM LOGS_ENHANCED BEFORE(STATEMENT => '01c18700-0207-694d-0019-aef7000c0fb6');

SELECT * FROM LOGS_ENHANCED BEFORE(STATEMENT => '01c18705-0207-694d-0019-aef7000c300e');


-------working
MERGE INTO ENHANCED.LOGS_ENHANCED e
USING (
SELECT logs.ip_address 
, logs.user_login as GAMER_NAME
, logs.user_event as GAME_EVENT_NAME
, logs.datetime_iso8601 as GAME_EVENT_UTC
, city
, region
, country
, timezone as GAMER_LTZ_NAME
, CONVERT_TIMEZONE( 'UTC',timezone,logs.datetime_iso8601) as game_event_ltz
, DAYNAME(game_event_ltz) as DOW_NAME
, TOD_NAME
from ags_game_audience.raw.LOGS logs
JOIN ipinfo_geoloc.demo.location loc 
ON ipinfo_geoloc.public.TO_JOIN_KEY(logs.ip_address) = loc.join_key
AND ipinfo_geoloc.public.TO_INT(logs.ip_address) 
BETWEEN start_ip_int AND end_ip_int
JOIN ags_game_audience.raw.TIME_OF_DAY_LU tod
ON HOUR(game_event_ltz) = tod.hour
) r
ON r.GAMER_NAME = e.GAMER_NAME
and r.game_event_utc = e.game_event_utc
and r.game_event_name = e.game_event_name
WHEN NOT MATCHED THEN
insert (IP_ADDRESS, GAMER_NAME, GAME_EVENT_NAME, GAME_EVENT_UTC, CITY, REGION, COUNTRY, GAMER_LTZ_NAME, GAME_EVENT_LTZ, DOW_NAME, TOD_NAME) --list of columns
values (IP_ADDRESS, GAMER_NAME, GAME_EVENT_NAME, GAME_EVENT_UTC, CITY, REGION, COUNTRY, GAMER_LTZ_NAME, GAME_EVENT_LTZ, DOW_NAME, TOD_NAME) --list of columns (but we can mark as coming from the r select)
;

create or replace task AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED
	warehouse=COMPUTE_WH
	schedule='5 minute'
	as select 'hello!';
    
use role accountadmin;
--You have to run this grant or you won't be able to test your tasks while in SYSADMIN role
--this is true even if SYSADMIN owns the task!!
grant execute task on account to role SYSADMIN;

use role sysadmin; 

--Now you should be able to run the task, even if your role is set to SYSADMIN
execute task AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED;

--the SHOW command might come in handy to look at the task 
show tasks in account;

--you can also look at any task more in depth using DESCRIBE
describe task AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED;


select count(*)
from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;


--Run the task to load more rows
execute task AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED;

--check to see how many rows were added (if any! HINT: Probably NONE!)
select count(*)
from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;


--Testing cycle for MERGE. Use these commands to make sure the Merge works as expected

--Write down the number of records in your table 
select * from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;

--Run the Merge a few times. No new rows should be added at this time 
EXECUTE TASK AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED;

--Check to see if your row count changed 
select * from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;

--Insert a test record into your Raw Table 
--You can change the user_event field each time to create "new" records 
--editing the ip_address or datetime_iso8601 can complicate things more than they need to 
--editing the user_login will make it harder to remove the fake records after you finish testing 
INSERT INTO ags_game_audience.raw.game_logs 
select PARSE_JSON('{"datetime_iso8601":"2025-01-01 00:00:00.000", "ip_address":"196.197.196.255", "user_event":"fake event", "user_login":"fake user01"}');

truncate table ags_game_audience.enhanced.LOGS_ENHANCED;


--After inserting a new row, run the Merge again 
EXECUTE TASK AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED;

--Check to see if any rows were added 
select * from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;

--When you are confident your merge is working, you can delete the raw records 
delete from ags_game_audience.raw.game_logs where raw_log like '%fake user01%';

--You should also delete the fake rows from the enhanced table
delete from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED
where gamer_name = 'fake user01';

--Row count should be back to what it was in the beginning
select * from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED; 


select * from AGS_GAME_AUDIENCE.RAW.pl_game_logs;





list @uni_kishore_pipeline;

CREATE OR REPLACE FILE FORMAT FF_JSON_LOGS
  TYPE = JSON
  STRIP_OUTER_ARRAY = TRUE
;

select $1 
from @uni_kishore_pipeline
(file_format => ff_json_logs);

truncate table AGS_GAME_AUDIENCE.RAW.pl_game_logs;

copy into ags_game_audience.raw.pl_game_logs
from @uni_kishore_pipeline
file_format = (format_name=ff_json_logs);

select raw_log:agent::text as AGENT 
, RAW_LOG:user_event::text as USER_EVENT 
, *
from pl_game_logs; 

SELECT * from pl_game_logs; 

EXECUTE TASK AGS_GAME_AUDIENCE.RAW.GET_NEW_FILES;

select RAW_LOG:ip_address::text as IP_ADDRESS 
, RAW_LOG:user_event::text as USER_EVENT
, RAW_LOG:user_login::text as USER_LOGIN
, RAW_LOG:datetime_iso8601::TIMESTAMP_NTZ as DATETIME_ISO8601
, *
from AGS_GAME_AUDIENCE.RAW.PL_game_logs
WHERE RAW_LOG:AGENT::TEXT IS NULL

CREATE OR REPLACE VIEW AGS_GAME_AUDIENCE.RAW.PL_LOGS  as (
select RAW_LOG:ip_address::text as IP_ADDRESS 
, RAW_LOG:user_event::text as USER_EVENT
, RAW_LOG:user_login::text as USER_LOGIN
, RAW_LOG:datetime_iso8601::TIMESTAMP_NTZ as DATETIME_ISO8601
, *
from AGS_GAME_AUDIENCE.RAW.PL_game_logs
WHERE RAW_LOG:AGENT::TEXT IS NULL
);

SELECT * from pl_logs; 

---before create merge test select


---WORKING-- this will be added in inside task - load_logs_enhanced
MERGE INTO ENHANCED.LOGS_ENHANCED e
USING (
SELECT logs.ip_address 
, logs.user_login as GAMER_NAME
, logs.user_event as GAME_EVENT_NAME
, logs.datetime_iso8601 as GAME_EVENT_UTC
, city
, region
, country
, timezone as GAMER_LTZ_NAME
, CONVERT_TIMEZONE( 'UTC',timezone,logs.datetime_iso8601) as game_event_ltz
, DAYNAME(game_event_ltz) as DOW_NAME
, TOD_NAME
from ags_game_audience.raw.PL_LOGS logs
JOIN ipinfo_geoloc.demo.location loc 
ON ipinfo_geoloc.public.TO_JOIN_KEY(logs.ip_address) = loc.join_key
AND ipinfo_geoloc.public.TO_INT(logs.ip_address) 
BETWEEN start_ip_int AND end_ip_int
JOIN ags_game_audience.raw.TIME_OF_DAY_LU tod
ON HOUR(game_event_ltz) = tod.hour
) r
ON r.GAMER_NAME = e.GAMER_NAME
and r.game_event_utc = e.game_event_utc
and r.game_event_name = e.game_event_name
WHEN NOT MATCHED THEN
insert (IP_ADDRESS, GAMER_NAME, GAME_EVENT_NAME, GAME_EVENT_UTC, CITY, REGION, COUNTRY, GAMER_LTZ_NAME, GAME_EVENT_LTZ, DOW_NAME, TOD_NAME) --list of columns
values (IP_ADDRESS, GAMER_NAME, GAME_EVENT_NAME, GAME_EVENT_UTC, CITY, REGION, COUNTRY, GAMER_LTZ_NAME, GAME_EVENT_LTZ, DOW_NAME, TOD_NAME) --list of columns (but we can mark as coming from the r select)
;

EXECUTE TASK AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED;

select * from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;

truncate table AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;


--Turning on a task is done with a RESUME command
alter task AGS_GAME_AUDIENCE.RAW.GET_NEW_FILES resume;
alter task AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED resume;

DESCRIBE TASK AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED;


select * from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;

--Turning OFF a task is done with a SUSPEND command
alter task AGS_GAME_AUDIENCE.RAW.GET_NEW_FILES suspend;
alter task AGS_GAME_AUDIENCE.RAW.LOAD_LOGS_ENHANCED suspend;

--Step 1 - how many files in the bucket?
list @AGS_GAME_AUDIENCE.RAW.UNI_KISHORE_PIPELINE;

--Step 2 - number of rows in raw table (should be file count x 10)
select count(*) from AGS_GAME_AUDIENCE.RAW.PL_GAME_LOGS;

--Step 3 - number of rows in raw view (should be file count x 10)
select count(*) from AGS_GAME_AUDIENCE.RAW.PL_LOGS;

--Step 4 - number of rows in enhanced table (should be file count x 10 but fewer rows is okay because not all IP addresses are available from the IPInfo share)
select count(*) from AGS_GAME_AUDIENCE.ENHANCED.LOGS_ENHANCED;


use role accountadmin;
grant EXECUTE MANAGED TASK on account to SYSADMIN;

--switch back to sysadmin
use role sysadmin;

USER_TASK_MANAGED_INITIAL_WAREHOUSE_SIZE = 'XSMALL';

 alter pipe PIPE_GET_NEW_FILES set pipe_execution_paused = true;


 create schema CURATED;

 


 
